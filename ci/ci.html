<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Kaitai Struct: test results - {{timestamp}}</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.21/vue.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
        .passed {
            background: #dff0d8;
        }
        .skipped {
            background: #b9cfbb;
        }
        .failed {
            background: #f2dede;
            cursor: pointer;
        }
        .leak, .format-build-failed, .spec-build-failed {
            background: #f2cece;
            cursor: pointer;
        }
        .no-run, .no-spec {
            background: #f2bebe;
        }
        th.section {
            text-align: center;
            font-size: 200%;
        }
        .add-info {
            position: absolute;
            display: none;
            background: #F0F0F0;
            border: 1px solid #A0A0A0;
        }

        table {
            border: 2px solid #42b983;
            border-radius: 3px;
            background-color: #fff;
        }

        th {
            background-color: #42b983;
            color: rgba(255,255,255,0.66);
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        td {
            background-color: #f9f9f9;
        }

        th, td {
            min-width: 120px;
            padding: 10px 20px;
        }

        th.active {
            color: #fff;
        }

        th.active .arrow {
            opacity: 1;
        }

        .arrow {
            display: inline-block;
            vertical-align: middle;
            width: 0;
            height: 0;
            margin-left: 5px;
            opacity: 0.66;
        }

        .arrow.asc {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid #fff;
        }

        .arrow.dsc {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #fff;
        }
    </style>
</head>
<body>

<!-- component template -->
<script type="text/x-template" id="cell-template">
    <td v-bind:class="classObject">{{ data.status || "unknown" }}</td>
</script>

<script type="text/x-template" id="grid-template">
    <table>
        <thead>
            <tr>
                <th v-for="key in columns"
                    @click="sortBy(key)"
                    :class="{ active: sortKey == key }">
                    {{ key.replace("/", " ") }}
                    <span class="arrow" :class="sortOrders[key] > 0 ? 'asc' : 'dsc'">
                    </span>
                </th>
            </tr>
            <tr>
                <th>Last update</th>
                <th v-for="key in columns"
                    v-if="key != 'name'">
                    {{ meta[key].timestamp | humanTime }}
                </th>
            </tr>
            <tr>
                <th>Rating</th>
                <th v-for="key in columns"
                    v-if="key != 'name'">
                    {{ passRating[key] }}%
                </th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="entry in filteredData">
                <td>{{ entry.name }}</td>
                <ci-cell
                    v-for="key in columns"
                    v-if="key != 'name'"
                    :data="entry[key] || {}">
                </ci-cell>
            </tr>
        </tbody>
    </table>
</script>

<div class="container">
    <div id="app">
        <h1>Kaitai Struct CI</h1>
<!--        <pre>{{ testData }}</pre>-->
        <form id="search">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <input name="query" class="form-control" v-model="searchQuery" placeholder="Search...">
                </div>
                <div class="form-check col-md-6">
                    <input type="checkbox" class="form-check-input" v-model="skipPassed" id="only-failures-checkbox">
                    <label class="form-check-label" for="only-failures-checkbox">Only failures</label>
                </div>
            </div>
        </form>
        <ci-grid
            :data="gridData"
            :columns="gridColumns"
            :meta="gridMeta"
            :filter-key="searchQuery"
            :skip-passed="skipPassed">
        </ci-grid>
    </div>
</div>

<script type="text/javascript">
Vue.component('ci-cell', {
    template: '#cell-template',
    props: {
        data: {}
    },
    computed: {
        classObject: function() {
            return {
                "passed": this.data.status == 'passed',
                "failed": this.data.status == 'failed',
                "leak": this.data.status == 'leak',
                "no-spec": this.data.status === undefined,
            };
        }
    }
});

// register the grid component
Vue.component('ci-grid', {
    template: '#grid-template',
    props: {
        data: Array,
        columns: Array,
        meta: Object,
        filterKey: String,
        skipPassed: Boolean
    },
    data: function () {
        var sortOrders = {}
        this.columns.forEach(function (key) {
            sortOrders[key] = 1
        })
        return {
            sortKey: '',
            sortOrders: sortOrders,
        }
    },
    computed: {
        filteredData: function () {
            var sortKey = this.sortKey
            var filterKey = this.filterKey && this.filterKey.toLowerCase()
            var order = this.sortOrders[sortKey] || 1
            var data = this.data
            if (filterKey) {
                data = data.filter(function (row) {
                    return Object.keys(row).some(function (key) {
                        return String(row[key]).toLowerCase().indexOf(filterKey) > -1
                    })
                })
            }
            if (this.skipPassed) {
                var columns = this.columns
                data = data.filter(function (row) {
                    return !(columns.every(function(key) {
                        return key == 'name' || (row[key] && row[key].status === 'passed');
                    }))
                })
            }
            if (sortKey) {
                data = data.slice().sort(function (a, b) {
                    a = a[sortKey]
                    b = b[sortKey]
                    return (a === b ? 0 : a > b ? 1 : -1) * order
                })
            }
            return data
        },
        passRating: function () {
            var r = {};
            for (var pair in this.meta) {
                r[pair] = Math.round(this.meta[pair].passed / this.data.length * 100 * 10.0) / 10.0;
            }
            return r;
        }
    },
    filters: {
        capitalize: function (str) {
            return str.charAt(0).toUpperCase() + str.slice(1)
        },
        humanTime: function (d) {
            var sec = (new Date() - d) / 1000;
            if (sec < 60) {
                return "just now";
            } else if (sec < 60 * 60) {
                return Math.round(sec / 60) + "m ago";
            } else if (sec < 24 * 60 * 60) {
                return Math.round(sec / (60 * 60)) + "h ago";
            } else {
                return Math.round(sec / (24 * 60 * 60)) + "d ago";
            }
        }
    },
    methods: {
        sortBy: function (key) {
            this.sortKey = key
            this.sortOrders[key] = this.sortOrders[key] * -1
        }
    }
})

window.vue = new Vue({
    el: '#app',
    data: {
        testData: {},
        searchQuery: '',
        gridColumns: ['name'],
        gridData: [],
        gridMeta: {},
        skipPassed: false,
    },
    created: function () {
        var pairs = [
            ["cpp_stl_98", "gcc4.8_linux"],
            ["cpp_stl_98", "clang3.5_linux"],
            ["cpp_stl_98", "clang7.3_osx"],
            ["cpp_stl_98", "msvc141_windows_x64"],
            ["cpp_stl_11", "gcc4.8_linux"],
            ["cpp_stl_11", "clang3.5_linux"],
            ["cpp_stl_11", "clang7.3_osx"],
            ["cpp_stl_11", "msvc141_windows_x64"],
            ["csharp", "mono5.18.0"],
            ["go", "1.10"],
            ["java", "openjdk7"],
            ["java", "oraclejdk8"],
            ["javascript", "nodejs4"],
            ["javascript", "nodejs7"],
            ["lua", "5.3"],
            ["perl", "5.24"],
            ["php", "7.1"],
            ["python", "2.7"],
            ["python", "3.6"],
            ["ruby", "1.9"],
            ["ruby", "2.3"],
        ];
        for (var i in pairs) {
            this.addOneJson(pairs[i][0], pairs[i][1]);
        }
    },
    methods: {
        addOneJson: function (lang, version) {
            var pair = lang + "/" + version;
            console.log("Querying data for", lang, version, pair);
            fetch("https://raw.githubusercontent.com/kaitai-io/ci_artifacts/" + pair + "/test_out/" + lang + "/ci.json").then(r =>
                r.json()
            ).then(json => {
                var meta = json.$meta;
                delete json['$meta'];
                console.log("Got answer for", pair, ", meta:", meta);

                // Aggregation
                var numPassed = 0;
                for (var testName in json) {
                    this.testData[testName] = this.testData[testName] || {"name": testName};
                    delete json[testName]["name"];
                    this.testData[testName][pair] = json[testName];
                    if (this.testData[testName][pair].status === 'passed') {
                        numPassed++;
                    }
                }

                // Generate output
                this.gridColumns.push(pair);
                this.gridData = [];
                for (var testName in this.testData) {
                    this.gridData.push(this.testData[testName]);
                }
                meta.passed = numPassed;
                meta.timestamp = new Date(meta.timestamp);
                this.gridMeta[pair] = meta;
            });
        }
    }
});
</script>
</body>
</html>
